<HTML>
<head>
<title>What's in the Box?</title>
<meta charset="UTF-8">
<style>
div.split {
  display: inline-block;
  vertical-align: top;
}
div.scroller {
  height: 100%;
  overflow-y: scroll;
}
.hidden {
  display:none !important;
}
.box {
  color: blue;
  text-decoration: underline;
  cursor: pointer;
}
.sel {

}
.boxcategory {
  font-weight: bold;
}
.activebox {
  background-color: yellow;
}
.inline-multi {
  display: inline-block;
}
.sel-label {
  display: flex;
  align-items: center;
  justify-content: flex-start;
}
div.sel-inner {
}
div.multititle {
  display: inline-block;
}
div.randButton {
  font-size: 200%;
  text-decoration:underline;
  cursor:pointer;
}
.winner{
  background-color:green;
  color:white;
}
.error{
  background-color:red;
  color:white;
}
.duration{
  margin-left: auto;
  margin-right: 3px;
  background: lightgray;
}
/* this just prevents double-click-selection */
.no_selection {
    -webkit-user-select: none; /* webkit (safari, chrome) browsers */
    -moz-user-select: none; /* mozilla browsers */
    -khtml-user-select: none; /* webkit (konqueror) browsers */
    -ms-user-select: none; /* IE10+ */
}
.category { font-weight: bold }
.level0 { padding-left: 0 }
.level1 { padding-left: 10px }
.level2 { padding-left: 20px }
.level3 { padding-left: 30px }
.level4 { padding-left: 40px }
.level5 { padding-left: 50px }
.level6 { padding-left: 60px }

</style>
</head>
<body>
  <div id="d_outer_boxes" class="split scroller">
    <h3>Boxes</h3>
    <label for="include_groups"><input type="checkbox" id="include_groups" onclick="setInclGroups(this.checked)"/>Include Multiparters</label>
    <br/>
    <label for="multi_group"><input type="checkbox" id="multi_group" onclick="setGrouped(this.checked)"/>Group Multiparters</label>
    <br/><br/>
    <div id="d_boxes"></div>
    <br/><br/><br/><br/>
    Auto-generated Boxes<br/>(still need to fill in the manual list)
    <div id="d_autoboxes"></div>
  </div>
  <div class="split scroller">
    <div id="d_sel_controls">
      <button onclick="sel_checkall(true)">Check All</button>
      <button onclick="sel_checkall(false)">Uncheck All</button>
      <hr/>
    </div>
    <div id="d_selections"></div>
  </div>
  <div id="d_result" class="split" style="position: absolute; right: 0;">
    <div id="randButton" class="randButton no_selection" onClick="randSelect()">PULL FROM THE BOX!</div>
    <br/>
    <label for="uncheck_on_win"><input type="checkbox" id="uncheck_on_win"/>Uncheck on Win</label>
    <br/><br/>
    <div id="winner" class="winner sel-label">
      <div id="winnernum" class="sel-inner"></div>
      <div id="winnertitle" class="sel-inner"></div>
    </div>
    <div id="winerror" class="error"></div>
  </div>
</body>
<script>
// TODO ITEMS:::
// DONE Q0:Chrono: neat. you should provide an option to auto uncheck things that have been selected

// DONE don't re-select same thing in a row
// - finish tag selector logic 

// DONE render and show those categories
// - box categories

// DONE checkbox controls (select/unselect all)



var data = [
  {type:"category",title:"FiM Episodes",tags:["ponyep"],content:[
    {type:"category",title:"Season 1",tags:["ponys1"],content:[
      {type:"multipart",parts:[
        {id:"1x01",num:"#001 1x01",title:"Friendship is Magic (Part 1)",tags:["mane6","twilight"]},
        {id:"1x02",num:"#002 1x02",title:"Friendship is Magic (Part 2)",tags:["mane6","twilight","nightmare"]}
      ],combined:
        {id:"1x01-1x02",title:"Friendship is Magic"}},
      {id:"1x03",num:"#003 1x03",title:"The Ticket Master",tags:["twilight"]},
      {id:"1x04",num:"#004 1x04",title:"Applebuck Season",tags:["applejack"]},
      {id:"1x05",num:"#005 1x05",title:"Griffon the Brush-Off",tags:["gilda"]},
      {id:"1x06",num:"#006 1x06",title:"Boast Busters",tags:["trixie","twilight"]},
      {id:"1x07",num:"#007 1x07",title:"Dragonshy",tags:["fluttershy"]},
      {id:"1x08",num:"#008 1x08",title:"Look Before You Sleep",tags:["applejack","rarity"]},
      {id:"1x09",num:"#009 1x09",title:"Bridle Gossip",tags:["zecora"]},
      {id:"1x10",num:"#010 1x10",title:"Swarm of the Century",tags:["twilight","twicrazy"]},
      {id:"1x11",num:"#011 1x11",title:"Winter Wrap Up",tags:["twilight"]},
      {id:"1x12",num:"#012 1x12",title:"Call of the Cutie",tags:["cmc","applebloom","twist"]},
      {id:"1x13",num:"#013 1x13",title:"Fall Weather Friends",tags:["rainbow","applejack"]},
      {id:"1x14",num:"#014 1x14",title:"Suited for Success",tags:["rarity"]},
      {id:"1x15",num:"#015 1x15",title:"Feeling Pinkie Keen",tags:["twilight","pinkie"]},
      {id:"1x16",num:"#016 1x16",title:"Sonic Rainboom",tags:["rainbow"]},
      {id:"1x17",num:"#017 1x17",title:"Stare Master",tags:["fluttershy","cmc"]},
      {id:"1x18",num:"#018 1x18",title:"The Show Stoppers",tags:["cmc"]},
      {id:"1x19",num:"#019 1x19",title:"A Dog and Pony Show",tags:["rarity"]},
      {id:"1x20",num:"#020 1x20",title:"Green Isn't Your Color",tags:["fluttershy","rarity"]},
      {id:"1x21",num:"#021 1x21",title:"Over a Barrel",tags:["braeburn","applejack"]},
      {id:"1x22",num:"#022 1x22",title:"A Bird in the Hoof",tags:["fluttershy","celestia"]},
      {id:"1x23",num:"#023 1x23",title:"The Cutie Mark Chronicles",tags:["cmc","mane6"]},
      {id:"1x24",num:"#024 1x24",title:"Owl's Well That Ends Well",tags:["spike"]},
      {id:"1x25",num:"#025 1x25",title:"Party of One",tags:["pinkie"]},
      {id:"1x26",num:"#026 1x26",title:"The Best Night Ever",tags:["mane6","spitfire"]},
    ]},{type:"category",title:"Season 2",tags:["ponys2"],content:[
      {type:"multipart",parts:[
        {id:"2x01",num:"#027 2x01",title:"The Return of Harmony (Part 1)",tags:["discord","mane6"]},
        {id:"2x02",num:"#028 2x02",title:"The Return of Harmony (Part 2)",tags:["discord","mane6"]},
      ],combined:
        {id:"2x01-2x02",title:"The Return of Harmony"}},
      {id:"2x03",num:"#029 2x03",title:"Lesson Zero",tags:["twilight","twicrazy"]},
      {id:"2x04",num:"#030 2x04",title:"Luna Eclipsed",tags:["luna","nightmarenight"]},
      {id:"2x05",num:"#031 2x05",title:"Sisterhooves Social",tags:["sweetie","rarity"]},
      {id:"2x06",num:"#032 2x06",title:"The Cutie Pox",tags:["applebloom"]},
      {id:"2x07",num:"#033 2x07",title:"May the Best Pet Win!",tags:["rainbow"]},
      {id:"2x08",num:"#034 2x08",title:"The Mysterious Mare Do Well",tags:["rainbow"]},
      {id:"2x09",num:"#035 2x09",title:"Sweet and Elite",tags:["rarity"]},
      {id:"2x10",num:"#036 2x10",title:"Secret of My Excess",tags:["spike"]},
      {id:"2x11",num:"#037 2x11",title:"Hearth's Warming Eve",tags:["mane6","hearthswarming"]},
      {id:"2x12",num:"#038 2x12",title:"Family Appreciation Day",tags:["applebloom","grannysmith","filthyrich"]},
      {id:"2x13",num:"#039 2x13",title:"Baby Cakes",tags:["pinkie"]},
      {id:"2x14",num:"#040 2x14",title:"The Last Roundup",tags:["applejack"]},
      {id:"2x15",num:"#041 2x15",title:"The Super Speedy Cider Squeezy 6000",tags:["cider","apples"]},
      {id:"2x16",num:"#042 2x16",title:"Read It and Weep",tags:["rainbow"]},
      {id:"2x17",num:"#043 2x17",title:"Hearts and Hooves Day",tags:["bigmac","cheerilee","cmc"]},
      {id:"2x18",num:"#044 2x18",title:"A Friend in Deed",tags:["pinkie","cranky"]},
      {id:"2x19",num:"#045 2x19",title:"Putting Your Hoof Down",tags:["fluttershy","ironwill"]},
      {id:"2x20",num:"#046 2x20",title:"It's About Time",tags:["twilight","twicrazy"]},
      {id:"2x21",num:"#047 2x21",title:"Dragon Quest",tags:["spike"]},
      {id:"2x22",num:"#048 2x22",title:"Hurricane Fluttershy",tags:["fluttershy","spitfire"]},
      {id:"2x23",num:"#049 2x23",title:"Ponyville Confidential",tags:["cmc"]},
      {id:"2x24",num:"#050 2x24",title:"MMMystery on the Friendship Express",tags:["pinkie","train"]},
      {type:"multipart",parts:[
        {id:"2x25",num:"#051 2x25",title:"A Canterlot Wedding (Part 1)",tags:["cadance","shiningarmor"]},
        {id:"2x26",num:"#052 2x26",title:"A Canterlot Wedding (Part 2)",tags:["chrysalis","cadance","changeling","shiningarmor"]},
      ],combined:
        {id:"2x25-2x26",title:"A Canterlot Wedding"}},
    ]},{type:"category",title:"Season 3",tags:["ponys3"],content:[
      {type:"multipart",parts:[
        {id:"3x01",num:"#053 3x01",title:"The Crystal Empire (Part 1)",tags:["sombra","cadance","shiningarmor","twilight","crystalempire"]},
        {id:"3x02",num:"#054 3x02",title:"The Crystal Empire (Part 2)",tags:["sombra","cadance","shiningarmor","spike","crystalempire"]},
      ],combined:
        {id:"3x01-3x02",title:"The Crystal Empire"}},
      {id:"3x03",num:"#055 3x03",title:"Too Many Pinkie Pies",tags:["pinkie"]},
      {id:"3x04",num:"#056 3x04",title:"One Bad Apple",tags:["cmc","babs"]},
      {id:"3x05",num:"#057 3x05",title:"Magic Duel",tags:["trixie","twilight","zecora"]},
      {id:"3x06",num:"#058 3x06",title:"Sleepless in Ponyville",tags:["scootaloo","luna"]},
      {id:"3x07",num:"#059 3x07",title:"Wonderbolts Academy",tags:["rainbow","spitfire"]},
      {id:"3x08",num:"#060 3x08",title:"Apple Family Reunion",tags:["applejack","babs","apples"]},
      {id:"3x09",num:"#061 3x09",title:"Spike at Your Service",tags:["spike","applejack"]},
      {id:"3x10",num:"#062 3x10",title:"Keep Calm and Flutter On",tags:["fluttershy","discord"]},
      {id:"3x11",num:"#063 3x11",title:"Just for Sidekicks",tags:["spike"]},
      {id:"3x12",num:"#064 3x12",title:"Games Ponies Play",tags:["mane6","crystalempire"]},
      {id:"3x13",num:"#065 3x13",title:"Magical Mystery Cure",tags:["twilight","mane6","musical"]},
    ]},{type:"category",title:"Season 4",tags:["ponys4"],content:[
      {type:"multipart",parts:[
        {id:"4x01",num:"#066 4x01",title:"Princess Twilight Sparkle (Part 1)",tags:["twilight","discord"]},
        {id:"4x02",num:"#067 4x02",title:"Princess Twilight Sparkle (Part 2)",tags:["twilight","discord","boxarc"]},
      ],combined:
        {id:"4x01-4x02",title:"Princess Twilight Sparkle"}},
      {id:"4x03",num:"#068 4x03",title:"Castle Mane-ia",tags:["mane6"]},
      {id:"4x04",num:"#069 4x04",title:"Daring Don't",tags:["rainbow","daringdo"]},
      {id:"4x05",num:"#070 4x05",title:"Flight to the Finish",tags:["scootaloo"]},
      {id:"4x06",num:"#071 4x06",title:"Power Ponies",tags:["mane6","spike"]},
      {id:"4x07",num:"#072 4x07",title:"Bats!",tags:["applejack","fluttershy"]},
      {id:"4x08",num:"#073 4x08",title:"Rarity Takes Manehattan",tags:["rarity","coco"]},
      {id:"4x09",num:"#074 4x09",title:"Pinkie Apple Pie",tags:["pinkie","applejack","apples"]},
      {id:"4x10",num:"#075 4x10",title:"Rainbow Falls",tags:["rainbow","spitfire","keyget","boxarc"]},
      {id:"4x11",num:"#076 4x11",title:"Three's a Crowd",tags:["cadance","twilight","discord"]},
      {id:"4x12",num:"#077 4x12",title:"Pinkie Pride",tags:["pinkie","cheese","musical","keyget","boxarc"]},
      {id:"4x13",num:"#078 4x13",title:"Simple Ways",tags:["rarity","applejack"]},
      {id:"4x14",num:"#079 4x14",title:"Filli Vanilli",tags:["fluttershy"]},
      {id:"4x15",num:"#080 4x15",title:"Twilight Time",tags:["twilight","cmc"]},
      {id:"4x16",num:"#081 4x16",title:"It Ain't Easy Being Breezies",tags:["fluttershy","keyget","boxarc","breezies"]},
      {id:"4x17",num:"#082 4x17",title:"Somepony to Watch Over Me",tags:["applebloom","applejack"]},
      {id:"4x18",num:"#083 4x18",title:"Maud Pie",tags:["pinkie","maud"]},
      {id:"4x19",num:"#084 4x19",title:"For Whom the Sweetie Belle Toils",tags:["sweetie","luna"]},
      {id:"4x20",num:"#085 4x20",title:"Leap of Faith",tags:["applejack","flimflam","apples","keyget","boxarc"]},
      {id:"4x21",num:"#086 4x21",title:"Testing Testing 1, 2, 3",tags:["rainbow","twilight"]},
      {id:"4x22",num:"#087 4x22",title:"Trade Ya!",tags:["mane6","makeawish"]},
      {id:"4x23",num:"#088 4x23",title:"Inspiration Manifestation",tags:["rarity","spike"]},
      {id:"4x24",num:"#089 4x24",title:"Equestria Games",tags:["crystalempire","spike"]},
      {type:"multipart",parts:[
        {id:"4x25",num:"#090 4x25",title:"Twilight's Kingdom (Part 1)",tags:["crystalempire","twilight","luna","celestia","discord","tirek","boxarc"]},
        {id:"4x26",num:"#091 4x26",title:"Twilight's Kingdom (Part 2)",tags:["twilight","discord","tirek","boxarc","keyget"]},
      ],combined:
        {id:"4x25-4x26",title:"Twilight's Kingdom"}},
    ]},{type:"category",title:"Season 5",tags:["ponys5"],content:[
      {type:"multipart",parts:[
        {id:"5x01",num:"#092 5x01",title:"The Cutie Map (Part 1)",tags:["starlight","mane6","bootycall"]},
        {id:"5x02",num:"#093 5x02",title:"The Cutie Map (Part 2)",tags:["starlight","mane6","bootycall"]},
      ],combined:
        {id:"5x01-5x02",title:"The Cutie Map"}},
      {id:"5x03",num:"#094 5x03",title:"Castle Sweet Castle",tags:["mane6"]},
      {id:"5x04",num:"#095 5x04",title:"Bloom & Gloom",tags:["applebloom","luna"]},
      {id:"5x05",num:"#096 5x05",title:"Tanks for the Memories",tags:["rainbow"]},
      {id:"5x06",num:"#097 5x06",title:"Appleoosa's Most Wanted",tags:["cmc","braeburn","troubleshoes"]},
      {id:"5x07",num:"#098 5x07",title:"Make New Friends but Keep Discord",tags:["celestia","smooze","discord","fluttershy","treehugger"]},
      {id:"5x08",num:"#099 5x08",title:"The Lost Treasure of Griffonstone",tags:["gilda","rainbow","pinkie","bootycall"]},
      {id:"5x09",num:"#100 5x09",title:"Slice of Life",tags:["cranky","EVERYONE","derpy","howdoIeventagthisshit"]},
      {id:"5x10",num:"#101 5x10",title:"Princess Spike",tags:["spike","cadance"]},
      {id:"5x11",num:"#102 5x11",title:"Party Pooped",tags:["pinkie","yaks","twicrazy"]},
      {id:"5x12",num:"#103 5x12",title:"Amending Fences",tags:["twilight","moondancer"]},
      {id:"5x13",num:"#104 5x13",title:"Do Princesses Dream of Magic Sheep?",tags:["luna","mane6"]},
      {id:"5x14",num:"#105 5x14",title:"Canterlot Boutique",tags:["rarity","sassy"]},
      {id:"5x15",num:"#106 5x15",title:"Rarity Investigates!",tags:["rarity","rainbow","spitfire"]},
      {id:"5x16",num:"#107 5x16",title:"Made in Manehattan",tags:["rarity","applejack","bootycall"]},
      {id:"5x17",num:"#108 5x17",title:"Brotherhooves Social",tags:["bigmac","applebloom"]},
      {id:"5x18",num:"#109 5x18",title:"Crusaders of the Lost Mark",tags:["cmc","musical"]},
      {id:"5x19",num:"#110 5x19",title:"The One Where Pinkie Pie Knows",tags:["pinkie","shiningarmor","cadance"]},
      {id:"5x20",num:"#111 5x20",title:"Hearthbreakers",tags:["pinkie","apples","maud","limestone","marble","applejack","hearthswarming"]},
      {id:"5x21",num:"#112 5x21",title:"Scare Master",tags:["fluttershy","nightmarenight"]},
      {id:"5x22",num:"#113 5x22",title:"What About Discord?",tags:["discord","twilight","twicrazy"]},
      {id:"5x23",num:"#114 5x23",title:"The Hooffields and McColts",tags:["fluttershy","twilight","bootycall"]},
      {id:"5x24",num:"#115 5x24",title:"The Mane Attraction",tags:["applejack","coloratura"]},
      {type:"multipart",parts:[
        {id:"5x25",num:"#116 5x25",title:"The Cutie Re-Mark (Part 1)",tags:["starlight","twilight","sombra"]},
        {id:"5x26",num:"#117 5x26",title:"The Cutie Re-Mark (Part 2)",tags:["starlight","twilight","chrysalis","changeling","zecora","nightmare"]},
      ],combined:
        {id:"5x25-5x26",title:"The Cutie Re-Mark"}},
    ]},{type:"category",title:"Season 6",tags:["ponys6"],content:[
      {type:"multipart",parts:[
        {id:"6x01",num:"#118 6x01",title:"The Crystalling (Part 1)",tags:["flurryheart","shiningarmor","cadance","crystalempire","starlight","sunburst"]},
        {id:"6x02",num:"#119 6x02",title:"The Crystalling (Part 2)",tags:["flurryheart","shiningarmor","cadance","crystalempire","starlight","sunburst"]},
      ],combined:
        {id:"6x01-6x02",title:"The Crystalling"}},
      {id:"6x03",num:"#120 6x03",title:"The Gift of the Maud Pie",tags:["pinkie","maud","rarity"]},
      {id:"6x04",num:"#121 6x04",title:"On Your Marks",tags:["applebloom"]},
      {id:"6x05",num:"#122 6x05",title:"Gauntlet of Fire",tags:["spike","ember"]},
      {id:"6x06",num:"#123 6x06",title:"No Second Prances",tags:["starlight","trixie","celestia"]},
      {id:"6x07",num:"#124 6x07",title:"Newbie Dash",tags:["rainbow","spitfire"]},
      {id:"6x08",num:"#125 6x08",title:"A Hearth's Warming Tail",tags:["starlight","musical","hearthswarming"]},
      {id:"6x09",num:"#126 6x09",title:"The Saddle Row Review",tags:["rarity","mane6","coco"]},
      {id:"6x10",num:"#127 6x10",title:"Applejack's \"Day\" Off",tags:["applejack","rarity"]},
      {id:"6x11",num:"#128 6x11",title:"Flutter Brutter",tags:["fluttershy","zephyrbreeze"]},
      {id:"6x12",num:"#129 6x12",title:"Spice Up Your Life",tags:["pinkie","rarity","bootycall"]},
      {id:"6x13",num:"#130 6x13",title:"Stranger Than Fan Fiction",tags:["rainbow","daringdo","quibble"]},
      {id:"6x14",num:"#131 6x14",title:"The Cart Before the Ponies",tags:["rainbow","applejack","rarity","cmc"]},
      {id:"6x15",num:"#132 6x15",title:"28 Pranks Later",tags:["rainbow"]},
      {id:"6x16",num:"#133 6x16",title:"The Times They Are A Changeling",tags:["spike","crystalempire","thorax","changeling"]},
      {id:"6x17",num:"#134 6x17",title:"Dungeons and Discords",tags:["discord","spike","bigmac"]},
      {id:"6x18",num:"#135 6x18",title:"Buckball Season",tags:["applejack","rainbow","fluttershy","pinkie","snails","sports"]},  //TODO: tag "sports" on other eps
      {id:"6x19",num:"#136 6x19",title:"The Fault in Our Cutie Marks",tags:["cmc","gryphon","gabby"]},
      {id:"6x20",num:"#137 6x20",title:"Viva Las Pegasus",tags:["applejack","fluttershy","bootycall","flimflam","laspegasus"]},
      {id:"6x21",num:"#138 6x21",title:"Every Little Thing She Does",tags:["starlight"]},
      {id:"6x22",num:"#139 6x22",title:"P.P.O.V.",tags:["applejack","rarity","pinkie","shipping"]},
      {id:"6x23",num:"#140 6x23",title:"Where the Apple Lies",tags:["applejack","bigmac","grannysmith","filthyrich","apples"]},  //TODO: 'past/history' tag
      {id:"6x24",num:"#141 6x24",title:"Top Bolt",tags:["rainbow","spitfire","twilight","makeawish"]},
      {type:"multipart",parts:[
        {id:"6x25",num:"#142 6x25",title:"To Where and Back Again (Part 1)",tags:["starlight","trixie","thorax","discord","changeling","chrysalis"]},
        {id:"6x26",num:"#143 6x26",title:"To Where and Back Again (Part 2)",tags:["starlight","trixie","thorax","discord","changeling","chrysalis"]},
      ],combined:
        {id:"6x25-6x26",title:"To Where and Back Again"}},
    ]}
  ]},
  {type:"category",title:"FiMFlamFilosophy / Dawn Somewhere",tags:["fimflam"],content:[
    {type:"category",title:"Rainbow Dash Presents",tags:["rdp"],content:[
      {id:"rdp01",num:"#1",title:"Bubbles",tags:[]},
      {id:"rdp02",num:"#2",title:"Cupcakes",tags:[]},
      {id:"rdp03",num:"#3",title:"Somewhere Only We Know",tags:[]},
      {id:"rdp04",num:"#4",title:"Spiderses",tags:[]},
      {id:"rdp05",num:"#5",title:"Captain Hook the Biker Gorilla",tags:[]},
      {id:"rdp06",num:"#6",title:"Haunting Nightmare",tags:[]},
      {id:"rdp07",num:"#7",title:"A Beautiful Day in Equestria",tags:[]},
      {id:"rdp08",num:"#8",title:"My Little Dashie",tags:[]},
      {id:"rdp09",num:"#9",title:"Bittersweet",tags:[]},
      {id:"rdp10",num:"#10",title:"The Star In Yellow",tags:[]},
    ]},
    {type:"category",title:"Mentally Advanced",tags:["mas"],content:[
      {type:"category",title:"Positive Eps (old series)",tags:["mas+"],content:[
        {id:"mas+01",num:"1",title:"Ticket Master",tags:[]},
        {id:"mas+02",num:"2",title:"Applebuck Season",tags:[]},
        {id:"mas+03",num:"3",title:"Griffon the Brush-Off",tags:[]},
        {id:"mas+04",num:"4",title:"Boast Busters",tags:[]},
        {id:"mas+05",num:"5",title:"Dragonshy",tags:[]},
        {id:"mas+06",num:"6",title:"Look Before You Sleep",tags:[]},
        {id:"mas+07",num:"7",title:"Bridle Gossip",tags:[]},
        {id:"mas+08",num:"8",title:"Swarm of the Century",tags:[]},
        {id:"mas+09",num:"9",title:"Winter Wrap Up",tags:[]},
        {id:"mas+10",num:"10",title:"Call of the Cutie",tags:[]},
        {id:"mas+12",num:"12",title:"Suited for Success",tags:[]},
        {id:"mas+13",num:"13",title:"Feeling Pinkie Keen",tags:[]},
        {id:"mas+14",num:"14",title:"Sonic Rainboom",tags:[]},
        {id:"mas+15",num:"15",title:"Stare Master",tags:[]},
        {id:"mas+16",num:"16",title:"The Show Stoppers",tags:[]},
        {id:"mas+17",num:"17",title:"A Dog and Pony Show",tags:[]},
        {id:"mas+18",num:"18",title:"Green Isn’t Your Color",tags:[]},
        {id:"mas+19",num:"19",title:"Over a Barrel",tags:[]},
        {id:"mas+20",num:"20",title:"A Bird in the Hoof",tags:[]},
        {id:"mas+21",num:"21",title:"The Cutie Mark Chronicles",tags:[]},
        {id:"mas+22",num:"22",title:"Owl’s Well That Ends Well",tags:[]},
        {id:"mas+23",num:"23",title:"Party of One",tags:[]},
      ]},
      {type:"category",title:"Negative Eps (new series)",tags:["mas-"],content:[
        {id:"mas-01",num:"-1",title:"The Ticket Master",tags:[]},
        {id:"mas-02",num:"-2",title:"Applebuck Season",tags:[]},
        {id:"mas-03",num:"-3",title:"Griffon the Brush-Off",tags:[]},
        {id:"mas-04",num:"-4",title:"Boast Busters",tags:[]},
        {id:"mas-05",num:"-5",title:"Dragonshy",tags:[]},
        {id:"mas-06",num:"-6",title:"Look Before You Sleep",tags:[]},
        {id:"mas-07",num:"-7",title:"Bridle Gossip",tags:[]},
        {id:"mas-08",num:"-8",title:"Swarm of the Century",tags:[]},
        {id:"mas-09",num:"-9",title:"Winter Wrap Up",tags:[]},
        {id:"mas-10",num:"-10",title:"Call of the Cutie",tags:[]},
        {id:"mas-11",num:"-11",title:"Fall Weather Friends",tags:[]},
        {id:"mas-12",num:"-12",title:"Suited for Success",tags:[]},
        {id:"mas-13",num:"-13",title:"Feeling Pinkie Keen",tags:[]},
        {id:"mas-14",num:"-14",title:"Sonic Rainboom",tags:[]},
        {id:"mas-15",num:"-15",title:"Stare Master",tags:[]},
        {id:"mas-16",num:"-16",title:"The Show Stoppers",tags:[]},
        {id:"mas-17",num:"-17",title:"Party of One",tags:[]},
        {id:"mas-18",num:"-18",title:"The Best Night Ever",tags:[]},
        {id:"mas-19",num:"-19",title:"Friendship is Magic Part 1",tags:[]},
        {id:"mas-20",num:"-20",title:"Friendship is Magic Part 2",tags:[]},
      ]},
    ]},
  ]},
];

var boxdata = [
  {name:"MLP:FiM",tags:"ponyep",itags:"",content:[
    {name:"Seasons",content:[
      {name:"S1",tags:"ponys1",itags:""},
      {name:"S2",tags:"ponys2",itags:""},
      {name:"S3",tags:"ponys3",itags:""},
      {name:"S4",tags:"ponys4",itags:""},
      {name:"S5",tags:"ponys5",itags:""},
      {name:"S6",tags:"ponys6",itags:""},
    ]},
    {name:"Characters",content:[
      {name:"Mane 6",tags:"mane6",content:[
        {name:"Twilight",tags:"twilight"},
        {name:"Applejack",tags:"applejack"},
        {name:"Rarity",tags:"rarity"},
        {name:"Rainbow Dash",tags:"rainbow"},
        {name:"Pinkie Pie",tags:"pinkie"},
        {name:"Fluttershy",tags:"fluttershy"},
      ]},
      {name:"CMC",tags:"cmc",content:[
        {name:"Applebloom",tags:"applebloom"},
        {name:"Scootaloo",tags:"scootaloo"},
        {name:"Sweetie Belle",tags:"sweetie"}
      ]},
      {name:"Secondary",content:[
        {name:"Spike",tags:"spike"},
        {name:"Discord",tags:"discord"},
        {name:"Cadance",tags:"cadance"},
        {name:"Starlight Glimmer",tags:"starlight"},
        {name:"Shining Armor",tags:"shiningarmor"},
        {name:"Spitfire",tags:"spitfire"},
        {name:"Luna",tags:"luna"},
      ]},
    ]},
    {name:"Arcs",content:[
      {name:"S4 Keys/Box Arc",tags:"boxarc"},
      {name:"S4 Keys",tags:"keyget"},
      {name:"Map/BootyCall",tags:"bootycall"},
    ]},
    {name:"Holidays",content:[
      {name:"Hearth's Warming Eve",tags:"hearthswarming"},
      {name:"Nightmare Night",tags:"nightmarenight"},
    ]},
    {name:"Musicals",tags:"musical"},
    {name:"Silly Boxes?",content:[
      {name:"APPUL",tags:"apples"},
      {name:"Twilight off her meds",tags:"twicrazy"},
    ]},
    {name:"Random/Testing",content:[
      {name:"Woodstick wants Twist",tags:"twist"},
      {name:"MojoBox (just showing multi-tag boxes)",tags:"applejack rarity"}
    ]},
  ]},
  {name:"FiM-Related FanWorks",content:[
    {name:"FiMFlamFilosophy",tags:"fimflam",content:[
      {name:"Rainbow Dash Presents",tags:"rdp"},
      {name:"Mentally Advanced Series",tags:"mas",content:[
        {name:"+",tags:"mas+"},
        {name:"-",tags:"mas-"},
      ]},
    ]},
  ]},
];

var selections_div = document.getElementById('d_selections');
var alltags = {};

// our option object
function boxItem (defObj,i_tags,parentDiv,level){
  var callback = this;
  var tagSelection = false;
  var hidden = false;
  
  // duration stuffs
  callback.duration = 0;
  if (defObj.duration){callback.duration = timeToSeconds(defObj.duration)}
  
  var tags = {};
  for (var tag in defObj.tags){tags[defObj.tags[tag]] = true}
  for (var tag in i_tags){tags[i_tags[tag]] = true}
  for (var tag in tags){alltags[tag] = (alltags[tag] || 0)+1}
  callback.tags = tags;

  var dom = buildSelDom(
    defObj.id,
    defObj.num,
    defObj.title,
    Object.keys(tags).join(),
    callback.duration
  );
  if (!parentDiv){parentDiv = selections_div}
  dom.div.classList.add("level"+level);
  parentDiv.appendChild(dom.div);

  callback.check = function(check){
    dom.checkbox.checked = check;
  };
  callback.tagSelect = function (q_tags){
    var matched = true;
    for (var tag in q_tags){if (!tags[q_tags[tag]]){matched = false}}
    if (matched){tagSelection = true}
  };
  callback.tagUnselect = function (q_tags){
    var matched = true;
    for (var tag in q_tags){if (!tags[q_tags[tag]]){matched = false}}
    if (matched){tagSelection = false}
  };
  callback.pushSelection = function (){
    if (tagSelection){ dom.div.classList.remove("hidden"); hidden=false;}
    else {dom.div.classList.add("hidden"); hidden=true;}
    callback.unwin();
    tagSelection = false;
    return !hidden;
  };
  callback.unwin = function (){
    dom.div.classList.remove("winner");
  };
  callback.getOption = function(){
    callback.unwin();
    var returnThing =[];
    if (!hidden && dom.checkbox.checked){
      returnThing[0] = {id:defObj.id,win:callback.win};
    }
    return returnThing;
  };
  callback.win = function(uncheck){
    dom.div.classList.add("winner");
    if (uncheck){dom.checkbox.checked = false}
    return {num:defObj.num,title:defObj.title};
  };
  callback.setGroup = function (){}; //multi-item placeholders
  callback.setInclGroups = function (){return !hidden};
  return callback;
}

//
// multiparter object
//
function boxMultiItem (defObj,i_tags,parentDiv,level){
  var callback = this;
  var tagSelection = false;
  var included = false;
  var grouped = false;
  var hidden = false;  //only grouped selection
  
  // Structure:
  //  parentDiv
  //    containerdiv
  //      singlesdiv
  //        <selections>
  //      multidiv
  //        <group selection>
  
  callback.duration = 0;
  
  var tags = {};
  for (var tag in defObj.tags){tags[defObj.tags[tag]] = true}
  for (var tag in i_tags){tags[i_tags[tag]] = true}
  
  var singles = new Array;
  var nums = [];
  var containerdiv = document.createElement("div");
  containerdiv.classList.add("level"+level);
  var singlesdiv = document.createElement("div");
  for (var ep in defObj.parts) {
    var s = new boxItem(defObj.parts[ep],i_tags,singlesdiv);
    for (var tag in s.tags){tags[tag] = true}

    nums.push(defObj.parts[ep].num);
    singles.push(s);
    callback.duration += s.duration;
  }
  containerdiv.appendChild(singlesdiv);
  
  var dom = buildSelDom(
    defObj.combined.id,
    nums,
    defObj.combined.title,
    Object.keys(tags).join(),
    callback.duration
  );
  var multidiv = document.createElement("div");
  multidiv.appendChild(dom.div);
  containerdiv.appendChild(multidiv);
  parentDiv.appendChild(containerdiv);
  
  callback.setGroup = function (i_grouped) {
    if (i_grouped){
      singlesdiv.classList.add("hidden");
      multidiv.classList.remove("hidden");
      grouped = true;
    } else {
      singlesdiv.classList.remove("hidden");
      multidiv.classList.add("hidden");
      grouped = false;
    }
  };
  function updateIncluded() {
    if (included){containerdiv.classList.remove('hidden')}
    else {containerdiv.classList.add('hidden')}
  }
  callback.setInclGroups = function (set_include) {
    if (set_include){ included = true }
    else { included = false }
    updateIncluded();
    if ( !included ){ return false; }
    var shown = (included && !hidden);
    for (var s in singles){shown = singles[s].setInclGroups() || shown}
    return shown;
  };
  callback.check = function(check){
    dom.checkbox.checked = check;
    for (var s in singles){singles[s].check(check)}
  };
  callback.tagSelect = function(q_tags){
    var matched = true;
    for (var tag in q_tags){if (!tags[q_tags[tag]]){matched = false}}
    if (matched){tagSelection = true}
    for (var s in singles){singles[s].tagSelect(q_tags)}
  };
  callback.tagUnselect = function(q_tags){
    var matched = true;
    for (var tag in q_tags){if (!tags[q_tags[tag]]){matched = false}}
    if (matched){tagSelection = false}
    for (var s in singles){singles[s].tagUnselect(q_tags)}
  };
  callback.pushSelection = function(){
    if (tagSelection){ dom.div.classList.remove("hidden"); hidden = false}
    else {dom.div.classList.add("hidden"); hidden = true}
    tagSelection = false;
    var shown = false;
    for (var s in singles){shown = singles[s].pushSelection() || shown}
    updateIncluded();
    callback.unwin();
    return (included && (!hidden || shown));
  };
  callback.unwin = function(){
    dom.div.classList.remove("winner");
    for (var s in singles){singles[s].unwin()}
  };
  callback.getOption = function(){
    callback.unwin();
    var returnThing = [];
    if (included && !hidden && grouped && dom.checkbox.checked){
      returnThing[0] = {id:defObj.combined.id,win:callback.win};
    } else if (included && !hidden && !grouped){
      for (var s in singles){
        var sThing = singles[s].getOption();
        if (sThing[0]){returnThing.push(sThing[0])};
      }
    }
    return returnThing;
  };
  callback.win = function(uncheck){
    dom.div.classList.add("winner");
    if (uncheck){dom.checkbox.checked = false}
    return {num:nums.join([separator='<br/>']),title:defObj.combined.title};
  }
  return callback;
}

//
// category object
//
function categoryItem(defObj,i_tags,parentDiv,level){
  var callback = this;
  var hidden = false;
  
  var tags = i_tags.concat(defObj.tags);
  
  var children = new Array;
  
  var titlediv = document.createElement("div");
  titlediv.classList.add("sel-inner");
  titlediv.classList.add("category");
  titlediv.appendChild(document.createTextNode(defObj.title));
  var div = document.createElement("div");
  div.classList.add("sel");
  var childrenDiv = document.createElement("div");
  div.appendChild(titlediv);
  var outerDiv = document.createElement("div");
  outerDiv.appendChild(div);
  outerDiv.appendChild(childrenDiv);
  outerDiv.classList.add("level"+level);
  parentDiv.appendChild(outerDiv);
  
  for (var item in defObj.content) {
    if (defObj.content[item].type == "category") {
      children.push(new categoryItem(defObj.content[item],tags,selections_div,level+1));
    } else if (defObj.content[item].type == "multipart") {
      children.push(new boxMultiItem(defObj.content[item],tags,selections_div,level+1));
    } else {
      children.push(new boxItem(defObj.content[item],tags,selections_div,level+1));
    }
  }
  
  // pushSelection and setInclGroups determine what shows,
  //  so we hide/unhide the category based on the returns
  //  ... and make sure to return our own
  callback.pushSelection = function(){
    var shown = false;
    for (var c in children){shown = children[c].pushSelection() || shown}
    if (shown){div.classList.remove('hidden')}else{div.classList.add('hidden')}
    return shown;
  };
  callback.setInclGroups = function(set_include) {
    var shown = false;
    for (var c in children){shown = children[c].setInclGroups(set_include) || shown}
    if (shown){div.classList.remove('hidden')}else{div.classList.add('hidden')}
    return shown;
  };
  
  // getOption needs to combine returns
  callback.getOption = function(){
    var returnThing = [];
    for (var c in children){
      var cThing = children[c].getOption();
      if (cThing[0]){returnThing = returnThing.concat(cThing)};
    }
    return returnThing;
  };
  
  // the rest of the callbacks just get passed through
  callback.setGroup = function(grouped){
    for (var c in children){children[c].setGroup(grouped)}
  }
  callback.tagSelect = function(q_tags){
    for (var c in children){children[c].tagSelect(q_tags)}
  }
  callback.tagUnselect = function(q_tags){
    for (var c in children){children[c].tagUnselect(q_tags)}
  }
  callback.unwin = function(){
    for (var c in children){children[c].unwin()}
  }
  callback.check = function(check){
    for (var c in children){children[c].check(check)}
  };
  return callback;
}

//
//  common dom elements builder
//
function buildSelDom(id,num,title,hover,duration){
  var checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.id = "c_" + id;
  checkbox.checked = true;
  var checkdiv = document.createElement("div");
  checkdiv.classList.add("sel-inner");
  checkdiv.appendChild(checkbox);
  
  if (!Array.isArray(num)){num = [num]}
  var numdiv = document.createElement("div");
  numdiv.classList.add("sel-inner");
  for (var i = 0; i < num.length; i++){
    if (i > 0){numdiv.appendChild(document.createElement("br"))}
    numdiv.appendChild(document.createTextNode(num[i]));
  }
  
  var titlediv = document.createElement("div");
  titlediv.classList.add("sel-inner");
  titlediv.appendChild(document.createTextNode(title));
  
  var label = document.createElement("label");
  label.htmlFor = checkbox.id;
  label.classList.add("sel-label");
  label.title = hover;
  
  label.appendChild(checkdiv);
  label.appendChild(numdiv);
  label.appendChild(document.createTextNode("\u00A0"));
  label.appendChild(titlediv);
  
  if (duration) {
    var durationDiv = document.createElement("div");
    //durationDiv.classList.add("sel-inner");
    durationDiv.classList.add("duration");
    durationDiv.appendChild(document.createTextNode(secondsToTime(duration)));
    label.appendChild(durationDiv);
  }
  
  var div = document.createElement("div");
  div.id = "s_" + id;
  div.classList.add("sel");
  div.appendChild(label);
  
  return {checkbox:checkbox,label:label,div:div};
}


// parse data
var items = [];
function traverseData(arr,tags){
  for (var obj in arr) {
    obj = arr[obj];
    if (!tags) {tags = []}  // there's gotta be a better way to do this
    if (obj.type == "category") {
      items.push(new categoryItem(obj,[],selections_div,0));
      //traverseData(obj.content,tags.concat(obj.tags));
    } else if (obj.type == "multipart") {
      items.push(new boxMultiItem(obj,tags,selections_div,0));
    } else {
      // no type means single entry
      items.push(new boxItem(obj,tags,selections_div,0));
    }
  }
}
traverseData(data);

function setGrouped(grouped){
  for (var item in items){
    items[item].setGroup(grouped);
  }
}
setGrouped(document.getElementById("multi_group").checked);

function setInclGroups(included){
  for (var item in items){
    items[item].setInclGroups(included);
  }
}
setInclGroups(document.getElementById("include_groups").checked);

function sel_checkall(check){
  for (var item in items){items[item].check(check)}
}

var boxesdiv = document.getElementById('d_boxes');
var autoboxesdiv = document.getElementById('d_autoboxes');
var selectedBox;

//see if we've been given tags to work with
var query = {};
if (location.search){
  parms = location.search.substring(1).split("&");
  for (var i=0;i<parms.length;i++){
    var pair = parms[i].split("=");
    query[pair[0]] = pair[1].split(",").sort().toString();
  }
}

function makeBox (boxd,parentDiv,level){
  var callback = this;
  
  var boxdiv = document.createElement("div");
  boxdiv.appendChild(document.createTextNode(boxd.name));
  boxdiv.classList.add('level'+level);
  parentDiv.appendChild(boxdiv);
  
  if (boxd.tags || boxd.itags) {
    boxdiv.classList.add('box');
    //TODO:  add complex-tag support
    var tags = boxd.tags.split(" ").sort();
    var params = "?tags="+tags.join();
    callback.select = function(){
      if (selectedBox){selectedBox.classList.remove('activebox')}
      for (var item_i in items){
        items[item_i].tagSelect(boxd.tags.split(" "));
        items[item_i].pushSelection();
      }
      selectedBox = boxdiv;
      boxdiv.classList.add('activebox');
      if(location.search != params){history.replaceState("","",params)};
    };
    boxdiv.onclick = callback.select;
    
    if (location.search == params){
      // TODO:  all of this more elegantly
      
      callback.select();
    }
  } else {
    boxdiv.classList.add('boxnocontent');
  }
  
  if (boxd.content) {
    boxdiv.classList.add('boxcategory');
    var cboxes = [];
    for (var cbox in boxd.content) {
      cboxes.push(new makeBox(boxd.content[cbox],parentDiv,level + 1));
    }
  }
  return callback;
}


function timeToSeconds(time) {
  var parts = time.split(":");
  var seconds = +parts[parts.length-1];
  if (parts[parts.length-2]){seconds += parts[parts.length-2] * 60}
  if (parts[parts.length-3]){seconds += parts[parts.length-3] * 60 * 60}
  return seconds;
}
function secondsToTime(seconds){
  var hours = Math.floor(seconds / (60*60));
  var mins = Math.floor((seconds - (hours * 60*60)) / 60);
  var secs = seconds - (hours * 60*60) - (mins * 60);
  var time = "";
  if (hours > 0){time += hours+":"}
  time += (hours>0&&mins<10) ? "0"+mins : mins;
  time += ":" + ((secs<10) ? "0"+secs : secs);
  return time;
}

// copied from http://stackoverflow.com/a/11811767
function getSortedKeys(obj) {
    var keys = []; for(var key in obj) keys.push(key);
    return keys.sort(function(a,b){return obj[b]-obj[a]});
}
var autoboxes = [];
var sortedTags = getSortedKeys(alltags);
for (var tag in sortedTags){
  autoboxes.push(new makeBox({name:sortedTags[tag],tags:sortedTags[tag]},autoboxesdiv));
}

// do the autoboxes first so the proper boxes will end up selected by query
var boxes = [];
for (var box_i in boxdata){
  boxes.push(new makeBox(boxdata[box_i],boxesdiv,0));
}

var curWinner = "";
var windiv = document.getElementById("winner");
var winnum = document.getElementById("winnernum");
var wintitle = document.getElementById("winnertitle");
var errdiv = document.getElementById("winerror");
var uncheck_on_win = document.getElementById('uncheck_on_win');


//
// get options, randomly select
//
function randSelect(){
  var options = [];
  var dupewin = 0;
  for (var item_i in items){
    var optObj = items[item_i].getOption();
    for (var opt in optObj){
      options.push(optObj[opt]);
      // check if the current winner is among the options
      if (optObj[opt].id == curWinner){dupewin = options.length}
    }
  }

  // remove the current winner from the options, unless there's only one
  if (options.length > 1 && dupewin){
    options.splice(dupewin - 1, 1);
  }

  winnum.innerHTML = "";
  wintitle.innerHTML = "";
  errdiv.innerHTML = "";
  
  if (options.length){
    var i_win = Math.floor(Math.random() * options.length);
    var winner = options[i_win].win(uncheck_on_win.checked);
    curWinner = options[i_win].id;
    winnum.innerHTML = winner.num;
    wintitle.innerHTML = "\u00A0" + winner.title;
  } else {
    curWinner = "";
    errdiv.innerHTML = "WE GOT NOTHING";
  }
}

</script>
</HTML>
